{% extends 'app_main/base.html' %}
{% load static %}

{% block style %}
    .content {
        padding: 0;
    }
{% endblock %}

{% block content %}
    <div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/pl_PL/sdk.js#xfbml=1&version=v18.0" nonce="4yZKh3fW"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script type="importmap">
        {
          "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
          }
        }
    </script>
    
    <div id = "link-panel-content" class="box">
        <div class="left">
        
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <form class="flex-grow-1 me-2">
                            <input class="form-control" type="search" placeholder="Search items"
                                   aria-label="Search items">
                        </form>
                        <select class="form-select me-2" style="width: auto;" aria-label="Sort items" >
                            <option selected>Sort by</option>
                            <option value="1">Name</option>
                            <option value="2">Price</option>
                            <option value="3">Date</option>
                        </select>
                        <select class="form-select" style="width: auto;" aria-label="Items per page"
                                v-model="selected_item" @change="onItemsPerPageChange">
                            <option value="5" >5 items</option>
                            <option value="10">10 items</option>
                            <option value="20">20 items</option>
                            <option value="50">50 items</option>
                        </select>
                    </div>
                </div>
            </nav>
            
            {% for link in links_with_forms %}
                <div class="one_link_panel {% if link.done %} done {% else %} not_done {% endif %}" onclick="clicked({{ link.link.id }}, '{{ link.link.link }}')" id="one_link_panel_{{ link.link.id }}">
                    <div style="width: 340px; font-size: 12px"><a href="{{ link.link.link }}" target="new"> {{ link.link.short_link }}</a></div>
                    <div style="width: 300px; font-size: 12px; margin: 0 5px">{{ link.link.date }}</div>

                    <form method="post" style="width: 400px; display: block;" id="form_{{ link.link.id }}">
                        {{ link.form.csrf_token }}
                        {% for field in link.form %}
                            {{ field }}
                        {% endfor %}
                    </form>

                    <div style="width: 200px; display: block">
                        <input type="button" style="float: right" value="Usuń" onclick="del({{ link.link.id }})">
                        <input type="button" style="float: right" value="Edytuj" onclick="window.location.href = '/edit_link/{{ link.link.id }}/link_panel'">

                    </div>
                </div>
            {% endfor %}

            <div class="pagination">
                {% if links_with_forms.has_previous %}
                    <a href="?page=1" class="page-link">&laquo; pierwsza</a>
                    <a href="?page={{ links_with_forms.previous_page_number }}" class="page-link">< poprzednia</a>
                {% endif %}

                <div class="current page-info">
                    Strona {{ links_with_forms.number }} z {{ links_with_forms.paginator.num_pages }}.
                </div>

                {% if links_with_forms.has_next %}
                    <a href="?page={{ links_with_forms.next_page_number }}" class="page-link">następna ></a>
                    <a href="?page={{ links_with_forms.paginator.num_pages }}" class="page-link">ostatnia &raquo;</a>
                {% endif %}
            </div>
        </div>
        <div class="right" id="right">
        </div>
    </div>

    <script type="module">
        import {createApp, ref} from 'vue'

        async function getItemsPerPage(selected_item) {
            await fetch(get_links_per_page_url)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("Network response was not ok.")
                    }
                }).then(data => {
                    console.log(data["links_per_page"])
                    selected_item.value = data["links_per_page"]

            }).catch(error => {
                console.error("Error:", error);
            })

        }
        
        createApp({
            setup() {
                const selected_item = ref(0);
                
                // Download the number of links per page from the server
                // and fill the variable selected_item to change form view
                getItemsPerPage(selected_item)
                
                const onItemsPerPageChange = () => {
                    console.log("item has changed: " + selected_item.value)
                    window.location.href = `${change_links_per_page_url}?new_count=${selected_item.value}`
                }
                
                return {
                    selected_item, onItemsPerPageChange
                }
            },
            delimiters: ['[[', ']]'],
        }).mount('#link-panel-content')
    </script>
    
    
    <script>
    function showFacebookPost(link) {
        document.getElementById('right').innerHTML = '<center><div class="fb-post" data-href="' + link + '" data-width="500" data-show-text="true"></div></center>';
        FB.XFBML.parse();
    }

    function showTwitterProfile(link) {
        document.getElementById('right').innerHTML = '<center><a class="twitter-timeline" href="' + link +
            '"></a> ' + '</center>';
        twttr.widgets.load();
    }

    function showTwitterPost(link) {
        document.getElementById('right').innerHTML = '<blockquote class="twitter-tweet"><a href="' + link +'"></a></blockquote>';
        twttr.widgets.load();
    }

    function show(link) {
        // check whether link is facebook post
        if (link.includes('facebook.com/post')) {
            showFacebookPost(link);
        } else if (link.includes('twitter.com') && link.includes('/status/')) {
            showTwitterPost(link);
        } else if (link.includes('twitter.com')) {
            showTwitterProfile(link);
        }
        else {
            document.getElementById('right').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%">' +
                '<div>Wyświetl <a href="' + link + '" target="new">link</a> w przeglądarce</div></div>';
        }


    }

    function del(id) {
        if (confirm("Czy na pewno chcesz usunąć link?")) {
            window.location.href = "/delete_link/" + id +"/link_panel";
        }
    }
    function  sendChange(e) {
        e.preventDefault()
        // get if of form that was changed
        let id = $(this).parent().attr('id').split('_')[1]

        let crsf = $(this).parent().children()
        console.log(crsf)

        // send ajax add category request
        $.ajax({
            url: '/change_category/' + id + '/' + $(this).val(),
            type: 'POST',
            data: $(this).parent().serialize(),
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(response) {
                if (response === 'done') {
                    $('#form_' + id).parent().removeClass('not_done').addClass('done');
                } else {
                    $('#form_' + id).parent().removeClass('done').addClass('not_done');
                }
            },
            error: function(error) {
                alert("Wystąpił nieoczekiwany błąd")
            }
        })
    }

    function getCookie(name) {
    let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // on load
    $(document).ready(function() {
        // iterate through all forms
        $('select').each(function() {
            $(this).change(sendChange);
        });
    });

    function clicked(id, link) {
        // remove last-clicked class from all elements
        $('.one_link_panel').removeClass('last-clicked');

        // add last-clicked class to clicked element
        $('#one_link_panel_' + id).addClass('last-clicked');

        // show
        show(link)
    }
    </script>

    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    
{#    <script src = "{% static 'app_main/link_panel_vue.js' %}" ></script>#}
    
{% endblock %}
